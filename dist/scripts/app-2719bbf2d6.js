!function(){"use strict";angular.module("gulpAngularMqttWs",["ngAnimate","ngCookies","ngSanitize","ui.router","ngMaterial","ngStorage"])}(),angular.module("gulpAngularMqttWs").directive("sidebarNetpieConfig",function(){return{templateUrl:"app/netpie/partials/sidebar.html",scope:{config:"=config"},restrict:"E",link:function(e,n,t){console.log(e)}}}),angular.module("gulpAngularMqttWs").controller("netpieCtrl",["$mdUtil","$mdSidenav","$scope","$http","$localStorage","$mdToast",function(e,n,t,a,i,o){var r=function(t){var a=e.debounce(function(){n(t).toggle().then(function(){console.log("toggle "+t+" is done")})},200);return a};t.toggleRight=r("right"),t.storage=i.$default({netpie:{appKey:"2syAvlZPSExXY3M",appSecret:"p5OMOHvdvFaTYSoAx1pvEUZNtD2EW6",appId:"HelloChiangMaiMakerClub"},netpieApp:[]}),t.config={netpie:{appKey:"2syAvlZPSExXY3M",appSecret:"p5OMOHvdvFaTYSoAx1pvEUZNtD2EW6",appId:"HelloChiangMaiMakerClub"}},console.log(t.config),t.setGear=function(e){t.config.netpie=e},t.getMqttPass=function(e){console.log("GETTING MQTT AUTH");var n="https://netpie-api.herokuapp.com/api/";n+=e.appKey+"/",n+=e.appSecret+"/",n+=e.appId,n+="?callback=JSON_CALLBACK",console.log(n),a.jsonp(n).success(function(n){console.log(n),t.data=n,t.loading=!1,t.appSuccess="Success";var a=!0;if(angular.forEach(t.storage.netpieApp,function(i,o){if(i.appId==e.appId&&i.appSecret==e.appSecret&&i.appKey==e.appKey){var r={};r.appId=i.appId,r.appKey=i.appKey,r.appSecret=i.appSecret;var d=angular.extend(r,n);t.storage.netpieApp[o].microgears.push(d),a=!1,console.log(d)}}),a){var i=angular.extend({},e,n);e.microgears=[],e.microgears.push(i),t.storage.netpieApp.push(e)}}).error(function(){console.log("FAILED",arguments),t.loading=!1,t.appError="Failed: "+arguments[1]+" "+arguments[0]})}}]),angular.module("gulpAngularMqttWs").directive("sidebarMqttConfig",function(){return{templateUrl:"app/main/partials/sidebar.html",restrict:"E",link:function(e,n,t){}}}),function(){"use strict";function e(e,n,t,a,i,o,r,d,l){function c(e,n,t,a){e.devices=a,e.deviceUUID=t,e.hide=function(e){n.hide(e)},e.cancel=function(){n.cancel()}}function s(e,n){e.config={host:"mqtt.espert.io",port:8e3},e.save=function(e){n.hide(e)}}c.$inject=["$scope","$mdDialog","deviceUUID","devices"],s.$inject=["$scope","$mdDialog"];var u=this;u.devices={},u.LWT={};var p=function(e){var n=r.debounce(function(){o(e).toggle().then(function(){l.debug("toggle "+e+" is done")})},200);return n};e.toggleRight=p("right"),e.storage=a.$default({config:{host:"mqtt.espert.io",port:8e3}}),e.closeNav=function(){o("right").close().then(function(){e.config=angular.extend({},e.storage.config)})},e.closeAndSaveNewConfig=function(n){o("right").close().then(function(){e.storage.config=n,e.operations.disconnect(),e.connect()})},e.config=angular.extend({},e.storage.config),e.onlineStatus="ALL",e.filterDevice={},e.filterDevice.name="";var m=function(){var n=function(n,t){try{var a=n.split("/"),i=a.length-1,o=a[i];if("online"==o){l.debug("online",a);var r=t.split("|"),d=r[0],c=r[1],s=r[1];l.debug("id",c,"mac",s,"status",d,new Date),s&&s===d&&(d="online"),u.LWT[s||c]=d,u.devices[s||c]&&(u.devices[s||c].status=d,l.debug(u),e.$apply())}else try{var p=JSON.parse(t),m=p.info&&p.info.id,g=p.d&&p.d.id;p.status=u.LWT[g||m]||"ONLINE"||"UNKNOWN",p.online="DEAD"!==p.status,u.devices[g||m]=p,delete u.devices.undefined,e.$apply()}catch(f){l.debug("Exception: "),l.debug("=====",t)}}catch(b){l.debug("EXCEPTION!!!",b),l.debug("EXCEPTION!!!",b),l.debug("EXCEPTION!!!",b)}};try{t.on("message",n)}catch(a){l.error("onmessage error",a)}};e.showDetail=function(n,t){d.show({controller:c,templateUrl:"app/main/partials/detail.html",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!0,locals:{deviceUUID:t,devices:e.allDevices}}).then(function(){},function(){l.info("You cancelled the dialog.")})};var g=function(){return!1};e.showFirstPopup=function(n){g()&&d.show({controller:s,templateUrl:"app/main/partials/firstPopup.html",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!1}).then(function(n){e.config=n,e.storage.config=n,o("right").open()},function(){l.debug("CALLING CONNECT.."),e.connect()})};e.allDevices=function(){return u.devices},e.connect=function(){e.status="CONNECTING",m(),u.devices={},angular.forEach(e.config,function(n,t){""==e.config[t]&&delete e.config[t]});var n=function(n){return function(t){e.failed=!0,l.error(n+" FAILED",t),e.status=n+" FAILED = "+t.errorMessage}},a={SUBSCRIPTION:{failFn:n("SUBSCRIPTION")},CONNECTION:{failFn:n("CONNECTION")}},i={disconnectGen:function(e){var n=e;return function(){l.info("disconnection called"),n.disconnect()}}};e.operations={subscribe:t.subscribe("/CMMC/#"),connect:t.connect(),config:e.config,disconnect:angular.noop},t.create(e.operations.config).then(e.operations.connect,a.CONNECTION.failFn).then(e.operations.subscribe,a.SUBSCRIPTION.failFn).then(function(n){angular.isUndefined(n)?(l.debug("CONTROLLER","UNKNOWN FAILED"),e.status="UNKNOWN FAILED"):(e.status="READY",e.operations.disconnect=i.disconnectGen(n))})},e.disconnect=function(){l.debug("CALLING DISCONNECT..."),e.operations.disconnect()},g()||e.connect()}e.$inject=["$scope","$timeout","myMqtt","$localStorage","$sessionStorage","$mdSidenav","$mdUtil","$mdDialog","$log"];var n={};angular.module("gulpAngularMqttWs").factory("myMqtt",["mqttwsProvider",function(e){var t=e(n);return t}]).controller("MainController",e)}(),function(){"use strict";function e(){function e(e){var n=this;n.relativeDate=e(n.creationDate).fromNow()}e.$inject=["moment"];var n={restrict:"E",templateUrl:"app/components/navbar/navbar.html",scope:{creationDate:"="},controller:e,controllerAs:"vm",bindToController:!0};return n}angular.module("gulpAngularMqttWs").directive("myNavBar",e)}(),angular.module("gulpAngularMqttWs").filter("status",function(){return function(e,n){if("ALL"==n)return e;var t={};return angular.forEach(e,function(e,a){e.status==n&&(t[a]=e)}),t}}).filter("name",function(){return function(e,n){var t={};return angular.forEach(e,function(e,a){e.d.myName.toLowerCase().indexOf(n.toLowerCase())>-1&&(t[a]=e)}),t}}).filter("isEmpty",function(){var e;return function(n){for(e in n)if(n.hasOwnProperty(e))return!1;return!0}}),angular.module("gulpAngularMqttWs").controller("aboutCtrl",["$scope",function(e){e.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("gulpAngularMqttWs").provider("mqttwsProvider",function(){this.$get=["$q","$window","$log",function(e,n,t){var a=function(e){var n=new Date;return e+"."+n.getTime()};return function(n){var i,o,r,d=!1,l=!0,c={},s={};return{on:function(e,n){c[e]=n},addListener:function(e,n){c[e]=n},create:function(n){var d=e.defer();return n=angular.extend(s,n),i=n.host,o=parseInt(n.port,10),t.debug("CREATE",n),n.clientId||(n.clientId=a("RANDOM"),t.debug("PROVIDER"," clientId = ",n.clientId)),r=new Paho.MQTT.Client(i,o,n.clientId),d.resolve(r),d.promise},subscribe:function(n,a){return t.info("[MQTTWSPROVIDER] DOING.. SUBSCRIBE =",arguments),a=a||{qos:0},function(){var i=e.defer(),o=function(){t.debug("PROVIDER","subscribe succeeded."),i.resolve(r)};return a.onSuccess=o,t.warn("being subscribed ",n,a),r.subscribe(n,a),t.debug("PROVIDER","SUB",n,a),i.promise}},connect:function(){return t.debug("[72] higher connect()"),function(){var n=e.defer(),a=function(){var e=c.connected||function(){t.debug("[77]..CONNECTED..")};t.debug("PROVIDER","CONNECTION CONNECTED"),e.call(null,arguments),n.resolve(arguments)},i=function(e){t.error("[86]..FAILED....",e),n.reject(e)},o={timeout:10,useSSL:d,mqttVersion:3,cleanSession:l,onSuccess:a,onFailure:i};return t.debug("[101] PROVIDER","OPTIONS",s),s.username&&(o.userName=s.username,o.password=s.password),t.info("MQTT CONNECTION OPTIONS = ",o),r.connect(o),r.onMessageArrived=function(e){try{var n=e.destinationName,a=e.payloadString,i=c.message||function(){console.log("EV")};t.info("onMessageArrived topic = ",n),i.apply(null,[n,a,e]);var o=c[n.toString()]||function(){console.log("EV2")};o.apply(null,[a,e])}catch(r){t.error("mqttProvider error",r)}},r.onConnectionLost=function(e){console.log("onConnection Lost ",e)},n.promise}}}}}]}),function(){"use strict";function e(e){e.debug("runBlock end")}e.$inject=["$log"],angular.module("gulpAngularMqttWs").run(e)}(),function(){"use strict";function e(e,n){e.state("home",{url:"/",templateUrl:"app/main/partials/main.html",controller:"MainController",controllerAs:"main"}).state("netpie",{url:"/netpie",templateUrl:"app/netpie/partials/netpie.html",controller:"netpieCtrl",controllerAs:"netpie"}).state("about",{url:"/about",templateUrl:"app/about/partials/about.html",controller:"aboutCtrl",controllerAs:"about"}),n.otherwise("/")}e.$inject=["$stateProvider","$urlRouterProvider"],angular.module("gulpAngularMqttWs").config(e)}(),function(){"use strict";angular.module("gulpAngularMqttWs").constant("toastr",toastr).constant("moment",moment)}(),function(){"use strict";function e(e,n,t){e.debugEnabled(!0),n.options.timeOut=3e3,n.options.positionClass="toast-top-right",n.options.preventDuplicates=!0,n.options.progressBar=!0}e.$inject=["$logProvider","toastr","$mdThemingProvider"],angular.module("gulpAngularMqttWs").config(e)}(),angular.module("gulpAngularMqttWs").run(["$templateCache",function(e){e.put("app/about/partials/about.html",'<md-content layout-fill=""><header><my-nav-bar creationdate="main.creationDate"></my-nav-bar></header><md-content>CMMC Devices has been developed by CMMC, credit to @allfake24, @nazt :)</md-content></md-content>'),e.put("app/components/navbar/navbar.html",'<md-toolbar layout="row" layout-align="center center"><md-button href="https://github.com/Swiip/generator-gulp-angular">CMMC Devices</md-button><section flex="" layout="row" layout-align="left center"><md-button href="#/" class="md-raised">Devices</md-button><md-button href="#/about" class="md-raised">About</md-button></section></md-toolbar>'),e.put("app/main/partials/detail.html",'<md-dialog flex="60"><md-toolbar><div class="md-toolbar-tools"><h2>{{ devices()[deviceUUID].d.myName }}</h2><span flex=""></span></div></md-toolbar><md-dialog-content layout-padding=""><h3>d</h3><div ng-repeat="(key, value) in devices()[deviceUUID].d" layout="row"><div flex="40">{{ key }}</div><div flex="60">{{ value }}</div></div><h3>info</h3><div ng-repeat="(key, value) in devices()[deviceUUID].info" layout="row"><div flex="40">{{ key }}</div><div flex="60">{{ value }}</div></div></md-dialog-content></md-dialog>'),e.put("app/main/partials/firstPopup.html",'<md-dialog flex="60"><md-toolbar><div class="md-toolbar-tools"><h2>Hello Gear</h2><span flex=""></span></div></md-toolbar><md-dialog-content md-dynamic-height=""><form name="newConfig" ng-submit="save(config)"><md-input-container><label>Host</label> <input ng-model="config.host" required=""></md-input-container><md-input-container><label>Port</label> <input ng-model="config.port" required=""></md-input-container><md-input-container><label>clientId</label> <input ng-model="config.clientId" required="" type="clientId"></md-input-container><md-input-container ng-show="data.cb_auth"><label>Username</label> <input ng-model="config.username"></md-input-container><md-input-container ng-show="data.cb_auth"><label>Password</label> <input ng-model="config.password" type="password"></md-input-container><md-checkbox ng-init="data.ssl=false" ng-model="data.ssl" aria-label="SSL" class="md-warn md-align-top-left"><md-checkbox ng-init="data.cb_auth=false" ng-model="data.cb_auth" aria-label="Checkbox 2" class="md-warn md-align-top-left">username & password</md-checkbox><md-input-container><md-button class="md-raised md-primary">Save</md-button></md-input-container></md-checkbox></form></md-dialog-content></md-dialog>'),e.put("app/main/partials/main.html",'<md-content layout-fill=""><header><my-nav-bar creationdate="main.creationDate"></my-nav-bar></header><section class="jumbotron"><div layout="row" layout-align="end center"><md-input-container><label>Filter by name</label> <input ng-model="filterDevice.name"></md-input-container><md-input-container><label>Status</label><md-select name="onlineStatus" ng-model="onlineStatus" required=""><md-optgroup label="Status"><md-option value="ALL">all</md-option><md-option value="ONLINE">online</md-option><md-option value="DEAD">offline</md-option></md-optgroup></md-select></md-input-container><md-button ng-click="toggleRight()" class="md-primary">Config</md-button><sidebar-mqtt-config></sidebar-mqtt-config></div>{{ status }}<div class="techs" layout-align="center"><md-card ng-class="device.status" ng-repeat="(key, device) in main.devices | name:filterDevice.name | status:onlineStatus | orderBy:\'status\'"><div class="thumbnail"><div class="caption"><h3>{{ device.d.myName }} - {{ device.status }}</h3><div ng-show="{{ device.info.id !=\'\' || device.d.id != \'\'}}">{{ device.info.id || device.d.id }}</div><div>{{ device.d.ip }}</div><div>{{ device.d.seconds }} ({{ device.d.subscription }})</div><div>{{ device.info.sensor || device.d.sensor || "?" }}</div><div ng-show="{{device.online}}">{{ device.info.id || device.d.id }}/status</div></div></div><div class="md-actions" layout="row" layout-align="end center"><md-button ng-click="showDetail($event, key)">Detail</md-button></div></md-card></div></section><div ng-init="showFirstPopup($event)"></div></md-content>'),e.put("app/main/partials/sidebar.html",'<section><md-sidenav class="md-sidenav-right md-whiteframe-z2" md-component-id="right" layout-align="start center"><md-toolbar class="md-theme-light" layout="row" layout-align="center center">Config</md-toolbar><md-content layout-padding="" class="autoScroll"><form ng-submit="closeAndSaveNewConfig(config)"><md-input-container><label>Host</label> <input ng-model="config.host" required=""></md-input-container><md-input-container><label>Port</label> <input ng-model="config.port" required=""></md-input-container><md-input-container ng-show="data.cb_auth"><label>Username</label> <input ng-model="config.username"></md-input-container><md-input-container ng-show="data.cb_auth"><label>Password</label> <input ng-model="config.password" type="password"></md-input-container><md-input-container ng-show="data.cb_clientId"><label>clientId</label> <input ng-model="config.clientId" type="clientId" required=""></md-input-container><md-checkbox ng-init="data.ssl=false" ng-model="data.ssl" aria-label="SSL" class="md-warn md-align-top-left">SSL</md-checkbox><md-checkbox ng-init="data.cb_auth=false" ng-model="data.cb_auth" aria-label="Checkbox 2" class="md-warn md-align-top-left">username & password</md-checkbox><md-checkbox ng-model="data.cb_clientId" aria-label="Checkbox 2" class="md-warn md-align-top-left">clientId</md-checkbox><md-input-container><md-button class="md-raised">Save</md-button></md-input-container></form><md-input-container><md-button class="md-raised md-warn" ng-click="closeNav()">Cancel</md-button></md-input-container></md-content></md-sidenav></section>'),e.put("app/netpie/partials/netpie.html",'<md-content layout-fill=""><header><my-nav-bar creationdate="main.creationDate"></my-nav-bar></header><md-button class="md-primary" ng-click="addApp = true">New App</md-button><md-button ng-click="toggleRight()" class="md-primary">Config</md-button><form name="app" style="width:70%" ng-show="addApp" ng-submit="loading = true; getMqttPass(newApp)"><md-input-container flex=""><label>AppID</label> <input required="" ng-model="newApp.appId" name="appId"><div ng-messages="app.appId.$error"><div ng-message="required">This is required.</div></div></md-input-container><md-input-container flex=""><label>App Key</label> <input required="" name="appKey" ng-model="newApp.appKey"><div ng-messages="app.appKey.$error"><div ng-message="required">This is required.</div></div></md-input-container><md-input-container flex=""><label>App Secret</label> <input required="" name="appSecret" ng-model="newApp.appSecret"><div ng-messages="app.appSecret.$error"><div ng-message="required">This is required.</div></div></md-input-container><div class="" ng-show="loading == false" ng-init="loading = false"><div ng-show="appError">{{ appError }}</div><md-button class="md-raised">Add</md-button><md-button class="md-raised md-warn" ng-click="addApp = false">Cancel</md-button></div><div><md-progress-circular md-mode="indeterminate" ng-show="loading"></md-progress-circular></div></form><div><md-content class="md-padding"><md-tabs md-selected="selectedIndex" md-border-bottom="" md-autoselect="" md-dynamic-height=""><md-tab ng-repeat="app in storage.netpieApp" label="{{app.appId}}"><div class="tab{{$index%4}}"><md-toolbar class="md-theme-light">App overview</md-toolbar><md-content layout-fill=""><md-list><md-subheader class="md-no-sticky">MASTER</md-subheader><md-list-item class="md-3-line"><md-card class="md-list-item-text"><div>Id : {{ app.appId }}</div><div>Key : {{ app.appKey }}</div><div>Secret : {{ app.appSecret }}</div></md-card></md-list-item></md-list></md-content><md-toolbar class="md-theme-light"><md-subheader class="md-no-sticky">MICRO GEARS</md-subheader><md-button class="md-fab md-mini" aria-label="Eat cake" ng-click="getMqttPass(app)">Add</md-button></md-toolbar><md-content><md-list-item class="md-3-line" ng-repeat="microgear in app.microgears"><md-card class="md-list-item-text" layout="column"><div>#define MQTT_USERNAME&nbsp; &nbsp; &nbsp; {{microgear.username}}</div><div>#define MQTT_PASSWORD&nbsp; &nbsp; &nbsp; {{microgear.password}}</div><div>#define MQTT_CLIENT_ID&nbsp; &nbsp; &nbsp; &nbsp; {{microgear.clientId}}</div><div>#define MQTT_PREFIX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "/HelloChiangMaiMakerClub/gearname"</div></md-card><md-button class="md-raised" ng-click="setGear(microgear)">Use this Gear</md-button></md-list-item></md-content></div></md-tab></md-tabs></md-content></div></md-content><sidebar-netpie-config config="config.netpie"><section>{{config}}<md-button ng-click="toggleRight()" class="md-primary">Config</md-button><sidebar-netpie-config config="config.netpie"></sidebar-netpie-config></section><section>Hello</section><a href="#" ng-click="getMqttPass()">NETPIE</a> <code width="80%">{{ Object.keys(data) }}</code></sidebar-netpie-config>'),e.put("app/netpie/partials/sidebar.html",'<section><md-sidenav class="md-sidenav-right md-whiteframe-z2" md-component-id="right" layout-align="start center"><md-toolbar class="md-theme-light" layout="row" layout-align="center center">Config</md-toolbar><md-content layout-padding="" class="autoScroll"><md-input-container><label>appKey</label> <input ng-model="config.appKey"></md-input-container><md-input-container><label>appSecret</label> <input ng-model="config.appSecret"></md-input-container><md-input-container><label>appId</label> <input ng-model="config.appId"></md-input-container><md-input-container><label>topic</label> <input ng-model="config.topic"></md-input-container><md-input-container><md-button class="md-raised" ng-click="save()">Save</md-button></md-input-container><md-input-container><md-button class="md-raised md-warn" ng-click="cancel()">Cancel</md-button></md-input-container></md-content></md-sidenav></section>')}]);