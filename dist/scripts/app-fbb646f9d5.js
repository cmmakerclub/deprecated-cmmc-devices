!function(){"use strict";angular.module("cmmcDevices",["ngAnimate","ngCookies","ngSanitize","ui.router","ngMaterial","ngStorage"])}(),angular.module("cmmcDevices").directive("sidebarMqttConfig",function(){return{templateUrl:"app/main/partials/sidebar.html",restrict:"E",link:function(e,n,t){}}}),function(){"use strict";function e(e){try{JSON.parse(e)}catch(n){return!1}return!0}function n(n,i,o,a,c,r,l,d,s){function u(e,n,t,i){e.devices=i,e.deviceUUID=t,e.hide=function(e){n.hide(e)},e.cancel=function(){n.cancel()}}function m(e,n){e.config={host:"mqtt.cmmc.io",port:8e3},e.save=function(e){n.hide(e)}}u.$inject=["$scope","$mdDialog","deviceUUID","devices"],m.$inject=["$scope","$mdDialog"];var g=angular.extend(this,{devices:{},LWT:{}});n.toggleRight=t("right",r,l,s),angular.extend(n,{data:{cb_auth:!0,cb_clientId:!0,ssl:!0}}),angular.extend(n,{data:{cb_auth:!0,cb_clientId:!0,ssl:!0}}),n.storage=a.$default({config:{host:"mqtt.cmmc.io",port:9001}}),n.closeNav=function(){r("right").close().then(function(){n.config=angular.extend({},n.storage.config)})},n.closeAndSaveNewConfig=function(e){r("right").close().then(function(){n.storage.config=e,n.operations.disconnect(),n.connect()})},n.config=angular.extend({},n.storage.config),angular.extend(n,{onlineStatus:"ALL",filterDevice:{name:""},$scope:{filterDevice:{}}});var p=function(){var t=function(t,i){try{var o=t.split("/"),a=o.length-1;s.debug("splitted topics",o),s.debug("max topic depth",a);var c,r,l,d=o[a];if("status"===d)if(e(i)){var u=JSON.parse(i),m=u.info&&u.info.device_id;angular.extend(u,{status:g.LWT[m]||"ONLINE"||"UNKNOWN",online:"DEAD"!==u.status}),u.status=1==u.d.door_open?"DEAD":"ONLINE",g.devices[m]=u,delete g.devices.undefined,n.$apply()}else s.error("INVALID JSON");else"online"==d&&(s.debug("online",o),c=i.split("|"),r=c[0],l=c[1],l===r&&(r="online"),s.debug("device_id",l,"mac",l,"status",r,new Date),g.LWT[l]=r,g.devices[l]&&(g.devices[l].status=r,s.debug(g),n.$apply()))}catch(p){s.debug("EXCEPTION!!!",p)}};try{o.on("message",t)}catch(i){console.log(i)}};n.showDetail=function(e,t){d.show({controller:u,templateUrl:"app/main/partials/detail.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,locals:{deviceUUID:t,devices:n.allDevices}}).then(function(){},function(){s.info("You cancelled the dialog.")})};var v=function(){null==n.config.host||""==n.config.host;return!0};n.showFirstPopup=function(e){console.log("showFirstPopUp"),v()&&(console.log("[] showFirstPopUp"),d.show({controller:m,templateUrl:"app/main/partials/firstPopup.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1}).then(function(e){n.config=e,n.storage.config=e,r("right").open()},function(){s.debug("CALLING CONNECT.."),n.connect()}))};n.allDevices=function(){return g.devices},n.connect=function(){n.status="CONNECTING...",p(),angular.extend(g,{devices:{}}),angular.forEach(n.config,function(e,t){""==n.config[t]&&delete n.config[t]}),n.operations={subscribe:function(){return o.subscribe("/CMMC/#")},connect:function(){return o.connect()},config:n.config,disconnect:angular.noop},o.create(n.operations.config).then(n.operations.connect).then(n.operations.subscribe).then(function(e){n.status="READY",n.operations.disconnect=function(){s.info("disconnection called"),e.disconnect()}})["catch"](function(e){n.failed=!0,s.error("CONNECT FAILED: ",e),n.status=e.errorMessage})},n.disconnect=function(){s.debug("CALLING DISCONNECT..."),n.operations.disconnect()},v()||n.connect()}n.$inject=["$scope","$timeout","myMqtt","$localStorage","$sessionStorage","$mdSidenav","$mdUtil","$mdDialog","$log"],angular.module("cmmcDevices").factory("myMqtt",["mqttwsProvider",function(e){return e({})}]).controller("MainController",n);var t=function(e,n,t,i){var o=function(){n(e).toggle().then(function(){i.debug("toggle "+e+" is done")})};return t.debounce(o,200)}}(),function(){"use strict";function e(){function e(e){var n=this;n.relativeDate=e(n.creationDate).fromNow()}e.$inject=["moment"];var n={restrict:"E",templateUrl:"app/components/navbar/navbar.html",scope:{creationDate:"="},controller:e,controllerAs:"vm",bindToController:!0};return n}angular.module("cmmcDevices").directive("myNavBar",e)}(),angular.module("cmmcDevices").filter("status",function(){return function(e,n){if("ALL"==n)return e;var t={};return angular.forEach(e,function(e,i){e.status==n&&(t[i]=e)}),t}}).filter("name",function(){return function(e,n){var t={};return angular.forEach(e,function(e,i){e.d.myName.toLowerCase().indexOf(n.toLowerCase())>-1&&(t[i]=e)}),t}}).filter("isEmpty",function(){var e;return function(n){for(e in n)if(n.hasOwnProperty(e))return!1;return!0}}),angular.module("cmmcDevices").controller("aboutCtrl",["$scope",function(e){e.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("cmmcDevices").provider("mqttwsProvider",function(){this.$get=["$q","$window","$log",function(e,n,t){var i=function(e){var n=new Date;return e+"."+n.getTime()};return function(n){var o,a,c,r=!1,l=!0,d={},s={};return{on:function(e,n){d[e]=n},addListener:function(e,n){d[e]=n},create:function(n){var r=e.defer();return n=angular.extend(s,n),o=n.host,a=parseInt(n.port,10),t.debug("CREATE",n),n.clientId||(n.clientId=i("RANDOM"),t.debug("PROVIDER"," clientId = ",n.clientId)),c=new Paho.MQTT.Client(o,a,n.clientId),r.resolve(c),r.promise},subscribe:function(n,t){var i=e.defer();return t=t||{qos:0},t.onSuccess=function(){i.resolve(c)},c.subscribe(n,t),i.promise},connect:function(){var n=e.defer(),i=function(){var e=d.connected||function(){t.debug("[69] DEFAULT CONNECTED..")};e.call(null,arguments),t.debug("[Provider] onSuccess","MQTT CONNECTED.."),n.resolve(arguments)},o=function(e){t.error("[86]..FAILED....",e),n.reject(e)},a={timeout:10,useSSL:r,mqttVersion:3,cleanSession:l,onSuccess:i,onFailure:o};return t.debug("[101] PROVIDER","OPTIONS",s),s.username&&angular.extend(a,{username:s.username,password:s.password}),t.info("MQTT CONNECTION OPTIONS = ",a),c.onMessageArrived=function(e){try{{var n=(e.destinationName,e.payloadString);d.message||angular.noop}console.log(n)}catch(i){t.error("[error] skipped. still running..",i)}},c.onConnectionLost=function(e){console.log("onConnection Lost ",e)},c.connect(a),n.promise}}}}]}),function(){"use strict";function e(e){e.debug("runBlock end")}e.$inject=["$log"],angular.module("cmmcDevices").run(e)}(),function(){"use strict";function e(e,n){e.state("home",{url:"/",templateUrl:"app/main/partials/main.html",controller:"MainController",controllerAs:"main"}).state("about",{url:"/about",templateUrl:"app/about/partials/about.html",controller:"aboutCtrl",controllerAs:"about"}),n.otherwise("/")}e.$inject=["$stateProvider","$urlRouterProvider"],angular.module("cmmcDevices").config(e)}(),function(){"use strict";angular.module("cmmcDevices").constant("toastr",toastr).constant("moment",moment)}(),function(){"use strict";function e(e,n,t){e.debugEnabled(!0),n.options.timeOut=3e3,n.options.positionClass="toast-top-right",n.options.preventDuplicates=!0,n.options.progressBar=!0}e.$inject=["$logProvider","toastr","$mdThemingProvider"],angular.module("cmmcDevices").config(e)}(),angular.module("cmmcDevices").run(["$templateCache",function(e){e.put("app/about/partials/about.html","<md-content layout-fill><header><my-nav-bar creationdate=main.creationDate></my-nav-bar></header><md-content>CMMC Devices has been developed by CMMC, credit to @allfake24, @nazt :)</md-content></md-content>"),e.put("app/components/navbar/navbar.html",'<md-toolbar layout=row layout-align="center center"><md-button href=https://cmmakerclub.com>CMMC Devices</md-button><section flex layout=row layout-align="left center"><md-button href="#/" class=md-raised>Devices</md-button><md-button href=#/about class=md-raised>About</md-button></section></md-toolbar>'),e.put("app/main/partials/_form_item.html",'<md-input-container><label>Host</label> <input ng-model=config.host required></md-input-container><md-input-container><label>Port</label> <input ng-model=config.port required></md-input-container><md-input-container ng-show=data.cb_auth><label>Username</label> <input ng-model=config.username></md-input-container><md-input-container ng-show=data.cb_auth><label>Password</label> <input ng-model=config.password type=password></md-input-container><md-input-container ng-show=data.cb_clientId><label>clientId</label> <input ng-model=config.clientId type=text required></md-input-container><div class=cmmc-checkboxes flex=100><md-checkbox ng-init="data.cb_auth=false" ng-model=data.cb_auth aria-label="Checkbox 2" class="md-warn md-align-top-left">username & password</md-checkbox></div><div class=cmmc-checkboxes flex=100><md-checkbox ng-model=data.cb_clientId aria-label="Checkbox 2" class="md-warn md-align-top-left">clientId</md-checkbox></div><div class=cmmc-checkboxes flex=100><md-checkbox ng-model=data.ssl aria-label=SSL class="md-warn md-align-top-left">SSL</md-checkbox></div><md-input-container><md-button class=md-raised flex=100>Save</md-button><md-button class="md-raised md-warn" ng-click=closeNav()>Cancel</md-button></md-input-container>'),e.put("app/main/partials/detail.html",'<md-dialog flex=60><md-toolbar><div class=md-toolbar-tools><h2>{{ devices()[deviceUUID].d.myName }}</h2><span flex></span></div></md-toolbar><md-dialog-content layout-padding><h3>d</h3><div ng-repeat="(key, value) in devices()[deviceUUID].d" layout=row><div flex=40>{{ key }}</div><div flex=60>{{ value }}</div></div><h3>info</h3><div ng-repeat="(key, value) in devices()[deviceUUID].info" layout=row><div flex=40>{{ key }}</div><div flex=60>{{ value }}</div></div></md-dialog-content></md-dialog>'),e.put("app/main/partials/firstPopup.html","<md-dialog flex=40><md-toolbar><div class=md-toolbar-tools><h2>Config</h2><span flex></span></div></md-toolbar><md-dialog-content md-dynamic-height><form name=newConfig ng-submit=save(config)><div ng-include=\"'app/main/partials/_form_item.html'\"></div><md-input-container></md-input-container></form></md-dialog-content></md-dialog>"),e.put("app/main/partials/main.html",'<md-content layout-fill><header><my-nav-bar creationdate=main.creationDate></my-nav-bar></header><section class=main-section md-dynamic-height><div layout=row layout-align="end center"><div layout=row lex=100 layout-align="end bottom"><md-input-container class=md-block flex-gt-sm><label>Filter device</label> <input ng-model=filterDevice.name></md-input-container><md-input-container><md-select name=onlineStatus ng-model=onlineStatus required><md-option value=ALL>All devices</md-option><md-option value=ONLINE>Online</md-option><md-option value=DEAD>Offline</md-option></md-select></md-input-container><md-button ng-click=toggleRight() class=md-primary>Config</md-button></div><sidebar-mqtt-config></sidebar-mqtt-config></div><md-content flex layout-padding layout-align=center>{{ status }}</md-content><div class=devices layout-align=center><md-card class=item ng-class=device.status ng-repeat="(key, device) in main.devices | name:filterDevice.name | status:onlineStatus | orderBy:\'status\'"><div class=thumbnail><div class=caption><h3>{{ device.d.myName }} - {{ device.status }}</h3><div>{{ device.d.counter }} ({{ device.d.millis/1000}} ms)</div><div>{{ device.d.ip || device.info.ip }}</div><div ng-show={{!!device.d.temp}}>temp={{ device.d.temp}} humid={{ device.d.humid}}</div><divn ng-show={{device.info.sensor}}>{{ device.info.sensor || device.d.sensor || "?" }}</divn><div>{{device.info.prefix}}/{{ device.info.device_id || device.d.device_id }}/status</div></div></div><div class=md-actions layout=row layout-align="end center"><md-button ng-click="showDetail($event, key)">Detail</md-button></div></md-card></div></section><div ng-init=showFirstPopup($event)></div></md-content>'),e.put("app/main/partials/sidebar.html",'<section><md-sidenav md-dynamic-height class="md-sidenav-right md-whiteframe-z2" md-component-id=right layout-align="start center"><md-toolbar class=md-theme-light layout=row layout-align="center center">Config SSS</md-toolbar><md-content layout-padding class=autoScroll md-dynamic-height><form ng-submit=closeAndSaveNewConfig(config)><div ng-include="\'app/main/partials/_form_item.html\'"></div></form></md-content></md-sidenav></section>')}]);