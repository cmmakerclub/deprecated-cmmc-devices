!function(){"use strict";angular.module("cmmcDevices",["ngAnimate","ngCookies","ngSanitize","ui.router","ngMaterial","ngStorage"])}(),angular.module("cmmcDevices").directive("sidebarMqttConfig",function(){return{templateUrl:"app/main/partials/sidebar.html",restrict:"E",link:function(e,t,n){}}}),function(){"use strict";function e(e){try{JSON.parse(e)}catch(t){return!1}return!0}function t(t,o,i,a,c,r,l,s,d){function u(e,t,n,o){e.devices=o,e.deviceUUID=n,e.hide=function(e){t.hide(e)},e.cancel=function(){t.cancel()}}function m(e,t){e.config={host:"mqtt.cmmc.io",port:8e3},e.save=function(e){t.hide(e)}}u.$inject=["$scope","$mdDialog","deviceUUID","devices"],m.$inject=["$scope","$mdDialog"];var g=angular.extend(this,{devices:{},LWT:{}});t.toggleRight=n("right",r,l,d),angular.extend(t,{data:{cb_auth:!0,cb_clientId:!0,ssl:!0}}),angular.extend(t,{data:{cb_auth:!0,cb_clientId:!0,ssl:!0}}),t.storage=a.$default({config:{host:"mqtt.cmmc.io",port:9001}}),t.closeNav=function(){r("right").close().then(function(){t.config=angular.extend({},t.storage.config)})},t.closeAndSaveNewConfig=function(e){r("right").close().then(function(){t.storage.config=e,t.operations.disconnect(),t.connect()})},t.config=angular.extend({},t.storage.config),angular.extend(t,{onlineStatus:"ALL",filterDevice:{name:""},$scope:{filterDevice:{}}});var p=function(){var n=function(n,o){try{var i=n.split("/"),a=i.length-1;d.debug("splitted topics",i),d.debug("max topic depth",a);var c,r,l,s=i[a];if("status"===s)if(e(o)){var u=JSON.parse(o),m=u.info&&u.info.device_id;angular.extend(u,{status:g.LWT[m]||"ONLINE"||"UNKNOWN",online:"DEAD"!==u.status}),u.status=1==u.d.door_open?"DEAD":"ONLINE",g.devices[m]=u,delete g.devices.undefined,t.$apply()}else d.error("INVALID JSON");else"online"==s&&(d.debug("online",i),c=o.split("|"),r=c[0],l=c[1],l===r&&(r="online"),d.debug("device_id",l,"mac",l,"status",r,new Date),g.LWT[l]=r,g.devices[l]&&(g.devices[l].status=r,d.debug(g),t.$apply()))}catch(p){d.debug("EXCEPTION!!!",p)}};try{i.on("message",n)}catch(o){console.log(o)}};t.showDetail=function(e,n){s.show({controller:u,templateUrl:"app/main/partials/detail.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,locals:{deviceUUID:n,devices:t.allDevices}}).then(function(){},function(){d.info("You cancelled the dialog.")})};var f=function(){null==t.config.host||""==t.config.host;return!1};t.showFirstPopup=function(e){console.log("showFirstPopUp"),f()&&(console.log("[] showFirstPopUp"),s.show({controller:m,templateUrl:"app/main/partials/firstPopup.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1}).then(function(e){t.config=e,t.storage.config=e,r("right").open()},function(){d.debug("CALLING CONNECT.."),t.connect()}))};t.allDevices=function(){return g.devices},t.connect=function(){t.status="CONNECTING...",p(),angular.extend(g,{devices:{}}),angular.forEach(t.config,function(e,n){""==t.config[n]&&delete t.config[n]}),t.operations={subscribe:function(){return i.subscribe("/CMMC/#")},connect:function(){return i.connect()},config:t.config,disconnect:angular.noop},i.create(t.operations.config).then(t.operations.connect).then(t.operations.subscribe).then(function(e){t.status="READY",t.operations.disconnect=function(){d.info("disconnection called"),e.disconnect()}})["catch"](function(e){t.failed=!0,d.error("CONNECT FAILED: ",e),t.status=e.errorMessage})},t.disconnect=function(){d.debug("CALLING DISCONNECT..."),t.operations.disconnect()},f()||t.connect()}t.$inject=["$scope","$timeout","myMqtt","$localStorage","$sessionStorage","$mdSidenav","$mdUtil","$mdDialog","$log"],angular.module("cmmcDevices").factory("myMqtt",["mqttwsProvider",function(e){return e({})}]).controller("MainController",t);var n=function(e,t,n,o){var i=function(){t(e).toggle().then(function(){o.debug("toggle "+e+" is done")})};return n.debounce(i,200)}}(),function(){"use strict";function e(){function e(e){var t=this;t.relativeDate=e(t.creationDate).fromNow()}e.$inject=["moment"];var t={restrict:"E",templateUrl:"app/components/navbar/navbar.html",scope:{creationDate:"="},controller:e,controllerAs:"vm",bindToController:!0};return t}angular.module("cmmcDevices").directive("myNavBar",e)}(),angular.module("cmmcDevices").filter("status",function(){return function(e,t){if("ALL"==t)return e;var n={};return angular.forEach(e,function(e,o){e.status==t&&(n[o]=e)}),n}}).filter("name",function(){return function(e,t){var n={};return angular.forEach(e,function(e,o){e.d.myName.toLowerCase().indexOf(t.toLowerCase())>-1&&(n[o]=e)}),n}}).filter("isEmpty",function(){var e;return function(t){for(e in t)if(t.hasOwnProperty(e))return!1;return!0}}),angular.module("cmmcDevices").controller("aboutCtrl",["$scope",function(e){e.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("cmmcDevices").provider("mqttwsProvider",function(){this.$get=["$q","$window","$log",function(e,t,n){var o=function(e){var t=new Date;return e+"."+t.getTime()};return function(t){var i,a,c,r=!1,l=!0,s={},d={};return{on:function(e,t){s[e]=t},addListener:function(e,t){s[e]=t},create:function(t){var r=e.defer();return t=angular.extend(d,t),i=t.host,a=parseInt(t.port,10),n.debug("CREATE",t),t.clientId||(t.clientId=o("RANDOM"),n.debug("PROVIDER"," clientId = ",t.clientId)),c=new Paho.MQTT.Client(i,a,t.clientId),r.resolve(c),r.promise},subscribe:function(t,n){var o=e.defer();return n=n||{qos:0},n.onSuccess=function(){o.resolve(c)},c.subscribe(t,n),o.promise},connect:function(){var t=e.defer(),o=function(){var e=s.connected||function(){n.debug("[69] DEFAULT CONNECTED..")};e.call(null,arguments),n.debug("[Provider] onSuccess","MQTT CONNECTED.."),t.resolve(arguments)},i=function(e){n.error("[86]..FAILED....",e),t.reject(e)},a={timeout:10,useSSL:r,mqttVersion:3,cleanSession:l,onSuccess:o,onFailure:i};return n.debug("[101] PROVIDER","OPTIONS",d),d.username&&angular.extend(a,{username:d.username,password:d.password}),n.info("MQTT CONNECTION OPTIONS = ",a),c.onMessageArrived=function(e){try{var t=e.destinationName,o=e.payloadString,i=s.message||angular.noop;i.apply(null,[t,o,e])}catch(a){n.error("[error] skipped. still running..",a)}},c.onConnectionLost=function(e){console.log("onConnection Lost ",e)},c.connect(a),t.promise}}}}]}),function(){"use strict";function e(e){e.debug("runBlock end")}e.$inject=["$log"],angular.module("cmmcDevices").run(e)}(),function(){"use strict";function e(e,t){e.state("home",{url:"/",templateUrl:"app/main/partials/main.html",controller:"MainController",controllerAs:"main"}).state("about",{url:"/about",templateUrl:"app/about/partials/about.html",controller:"aboutCtrl",controllerAs:"about"}),t.otherwise("/")}e.$inject=["$stateProvider","$urlRouterProvider"],angular.module("cmmcDevices").config(e)}(),function(){"use strict";angular.module("cmmcDevices").constant("toastr",toastr).constant("moment",moment)}(),function(){"use strict";function e(e,t,n){e.debugEnabled(!0),t.options.timeOut=3e3,t.options.positionClass="toast-top-right",t.options.preventDuplicates=!0,t.options.progressBar=!0}e.$inject=["$logProvider","toastr","$mdThemingProvider"],angular.module("cmmcDevices").config(e)}(),angular.module("cmmcDevices").run(["$templateCache",function(e){e.put("app/about/partials/about.html","<md-content layout-fill><header><my-nav-bar creationdate=main.creationDate></my-nav-bar></header><md-content>CMMC Devices has been developed by CMMC, credit to @allfake24, @nazt :)</md-content></md-content>"),e.put("app/components/navbar/navbar.html",'<md-toolbar layout=row layout-align="center center"><md-button href=https://cmmakerclub.com>CMMC Devices</md-button><section flex layout=row layout-align="left center"><md-button href="#/" class=md-raised>Devices</md-button><md-button href=#/about class=md-raised>About</md-button></section></md-toolbar>'),e.put("app/main/partials/_form_item.html",'<md-input-container><label>Host</label> <input ng-model=config.host required></md-input-container><md-input-container><label>Port</label> <input ng-model=config.port required></md-input-container><md-input-container ng-show=data.cb_auth><label>Username</label> <input ng-model=config.username></md-input-container><md-input-container ng-show=data.cb_auth><label>Password</label> <input ng-model=config.password type=password></md-input-container><md-input-container ng-show=data.cb_clientId><label>clientId</label> <input ng-model=config.clientId type=text required></md-input-container><div class=cmmc-checkboxes flex=100><md-checkbox ng-init="data.cb_auth=false" ng-model=data.cb_auth aria-label="Checkbox 2" class="md-warn md-align-top-left">username & password</md-checkbox></div><div class=cmmc-checkboxes flex=100><md-checkbox ng-model=data.cb_clientId aria-label="Checkbox 2" class="md-warn md-align-top-left">clientId</md-checkbox></div><div class=cmmc-checkboxes flex=100><md-checkbox ng-model=data.ssl aria-label=SSL class="md-warn md-align-top-left">SSL</md-checkbox></div><md-input-container><md-button class=md-raised flex=100>Save</md-button><md-button class="md-raised md-warn" ng-click=closeNav()>Cancel</md-button></md-input-container>'),e.put("app/main/partials/detail.html",'<md-dialog flex=60><md-toolbar><div class=md-toolbar-tools><h2>{{ devices()[deviceUUID].d.myName }}</h2><span flex></span></div></md-toolbar><md-dialog-content layout-padding><h3>d</h3><div ng-repeat="(key, value) in devices()[deviceUUID].d" layout=row><div flex=40>{{ key }}</div><div flex=60>{{ value }}</div></div><h3>info</h3><div ng-repeat="(key, value) in devices()[deviceUUID].info" layout=row><div flex=40>{{ key }}</div><div flex=60>{{ value }}</div></div></md-dialog-content></md-dialog>'),e.put("app/main/partials/firstPopup.html","<md-dialog flex=40><md-toolbar><div class=md-toolbar-tools><h2>Config</h2><span flex></span></div></md-toolbar><md-dialog-content md-dynamic-height><form name=newConfig ng-submit=save(config)><div ng-include=\"'app/main/partials/_form_item.html'\"></div><md-input-container></md-input-container></form></md-dialog-content></md-dialog>"),e.put("app/main/partials/main.html",'<md-content layout-fill><header><my-nav-bar creationdate=main.creationDate></my-nav-bar></header><section class=main-section md-dynamic-height><div layout=row layout-align="end center"><div layout=row flex=100 layout-align="end bottom"><md-input-container class=md-block flex-gt-sm><label>Filter device</label> <input ng-model=filterDevice.name></md-input-container><md-input-container><md-select name=onlineStatus ng-model=onlineStatus required><md-option value=ALL>All devices</md-option><md-option value=ONLINE>Online</md-option><md-option value=DEAD>Offline</md-option></md-select></md-input-container><md-button ng-click=toggleRight() class=md-primary>Config</md-button></div><sidebar-mqtt-config></sidebar-mqtt-config></div><md-content flex layout-padding layout-align=center>{{ status }}</md-content><div class=devices layout-align=center><md-card class=item ng-class=device.status ng-repeat="(key, device) in main.devices | name:filterDevice.name | status:onlineStatus | orderBy:\'status\'"><div class=thumbnail flex=100 layout=column layout-align="center center"><div class=device-name>Item No. 481201</div><div class=item-status layout-align="center center"><span ng-hide=device.status>NOT</span>DETECTED</div></div><div class=md-actions layout=row layout-align="end center"><md-button ng-click="showDetail($event, key)">Detail</md-button></div></md-card></div></section><div ng-init=showFirstPopup($event)></div></md-content>'),e.put("app/main/partials/sidebar.html",'<section><md-sidenav md-dynamic-height class="md-sidenav-right md-whiteframe-z2" md-component-id=right layout-align="start center"><md-toolbar class=md-theme-light layout=row layout-align="center center">Config SSS</md-toolbar><md-content layout-padding class=autoScroll md-dynamic-height><form ng-submit=closeAndSaveNewConfig(config)><div ng-include="\'app/main/partials/_form_item.html\'"></div></form></md-content></md-sidenav></section>')}]);